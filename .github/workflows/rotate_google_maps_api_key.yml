name: Rotate and List Google Maps API Keys

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight UTC time to be consistent across timezone
  workflow_dispatch:

jobs:
  rotate-and-list-keys:
    runs-on: ubuntu-latest
    steps:
      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2.1.0'
        with:
          version: '475.0.0'

      # Retrieve old API key (assuming it's already known which one to rotate)
      - name: Get old API key uid
        id: get-old-key-uid
        run: |
          API_KEYS=$(gcloud services api-keys list --filter="displayName:Google Maps Key" --format="json")
          if [ "$(echo "$API_KEYS" | jq length)" -gt 0 ]; then
            OLD_API_KEY_UID=$(echo "$API_KEYS" | jq -r '.[0].uid')
            echo "OLD_API_KEY_UID=$OLD_API_KEY_UID" >> $GITHUB_ENV
          else
            echo "No existing API key found."
          fi

      - name: Generate new API key
        id: create-key
        run: |
          gcloud services api-keys create --display-name="Google Maps Key" > /dev/null
          echo "New API key generated."

      - name: Get new API key path
        id: get-new-key-path
        run: |
          API_KEYS=$(gcloud services api-keys list --filter="displayName:Google Maps Key" --format="json")
          if [ "$(echo "$API_KEYS" | jq length)" -gt 0 ]; then
            NEW_API_KEY_UID=""
            for key in $(echo "$API_KEYS" | jq -r '.[] | .uid'); do
              if [ -z "$OLD_API_KEY_UID" ]; then
                NEW_API_KEY_UID=$key
                break
              elif [ "$key" != "$OLD_API_KEY_UID" ]; then
                NEW_API_KEY_UID=$key
                break
              fi
            done
            if [ -n "$NEW_API_KEY_UID" ]; then
              NEW_API_KEY_PATH=$(echo "$API_KEYS" | jq -r --arg uid "$NEW_API_KEY_UID" '.[] | select(.uid == $uid) | .name')
              echo "NEW_API_KEY_PATH=$NEW_API_KEY_PATH" >> $GITHUB_ENV
            else
              echo "No new API key found with a different UID than the old one."
            fi
          else
            echo "No existing API key found."
          fi

      - name: Get new API key by path
        id: get-new-key
        run: |
          NEW_API_KEY=$(gcloud services api-keys get-key-string $NEW_API_KEY_PATH --format=json | jq -r '.keyString')
          echo "NEW_API_KEY=$NEW_API_KEY" >> $GITHUB_ENV

      # Store the new API key in Azure Key Vault
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set new API key in Azure Key Vault
        run: |
          if [ -z "$NEW_API_KEY" ]; then
            echo "Error: NEW_API_KEY is empty."
            exit 1
          else
            az keyvault secret set --vault-name GMapsKeyVault --name GoogleMapKey --value "$NEW_API_KEY" > /dev/null
            echo "New API key stored in Azure Key Vault"
          fi

      # List all Google Maps API keys after creating new one
      - name: List all API keys
        run: |
          API_KEYS_JSON=$(gcloud services api-keys list --filter="displayName:Google Maps Key" --format="json")
          echo "$API_KEYS_JSON" | jq '.'
          echo "::set-output name=api_keys::$API_KEYS_JSON"

      # Delete the old API key by uid
      - name: Delete old API key by uid
        if: env.OLD_API_KEY_UID != ''
        run: |
          # Delete the old API key
          gcloud services api-keys delete $OLD_API_KEY_UID --quiet

          echo "Old API key disabled or deleted"